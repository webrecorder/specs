<html>
  <head>
  <title>Web Archive Collection Zipped (WACZ)</title>
  <script src="https://www.w3.org/Tools/respec/respec-w3c" class="remove" defer ></script>
  <script class="remove">
    var respecConfig = {
      specStatus: "unofficial",
      thisVersion: "https://webrecorder.github.io/wacz-spec/1.2.0/",
      latestVersion: "https://webrecorder.github.io/wacz-spec/latest/",
      shortName: "wacz",
      lint: {
	// turn off w3c-specific linting
	"privsec-section": false,
	"no-http-props": false,
	"no-headingless-sections": false
      },
      includePermalinks: true,
      editors: [
	{
	  name: "Ilya Kreymer",
	  url: "https://www.linkedin.com/in/ilya-kreymer-55110093/",
	  company: "Webrecorder",
	  companyURL: "https://webrecorder.net/"
	},
        {
          name: "Ed Summers",
          url: "https://www.linkedin.com/in/esummers/",
          company: "Stanford University",
          companyURL: "https://stanford.edu"
        }
      ],
      group: {
        name: "WACZ Editors",
        url: "https://webrecorder.net"
      },
      wgPublicList: "",
      otherLinks: [
	{
	  key: "Additional Documents",
	  data: [
	    {
	      value: "Use Cases for Decentralized Web Archives",
	      href: "https://webrecorder.github.io/wacz-spec/use-cases/",
	    }
	  ]
	},
	{
	  key: "Previous version",
	  data: [
	      {
		  value: "1.1.1",
		  href: "https://github.com/webrecorder/wacz-spec/tree/4fb485e018f45996bfb1d992f937b67f3d6c79a9"
	      }
	  ]
      	},
	{
	  key: "Repository",
	  data: [
	    {
	      value: "Github",
	      href: "https://github.com/webrecorder/wacz-spec"
	    },
	    {
	      value: "Issues",
	      href: "https://github.com/webrecorder/wacz-spec/issues"
	    },
	    {
	      value: "Commits",
	      href: "https://github.com/webrecorder/wacz-spec/commits"
	    }
	  ]
      	}
      ],
      maxTocLevel: 3,
      logos: [
	{
	  src: "https://webrecorder.github.io/wacz-spec/1.2.0/images/wacz.png",
	  alt: "WACZ Logo",
          height: 100
      	}
      ],
      localBiblio: {
        "WEBRECORDER-CDX": {
          title: "Webrecorder CDX Index Format",
          publisher: "Webrecorder",
          href: "https://github.com/webrecorder/pywb/wiki/CDX-Index-Format",
          rawDate: "2015-03-25"
        },
        "WACZ-SIGNING": {
          title: "WACZ Signing/Verification Specification",
          publisher: "Webrecorder",
          href: "https://github.com/webrecorder/wacz-auth-spec/blob/main/spec.md",
          rawDate: "2022-01-25"
        }
      }
    };
  </script>
  </head>

  <body>

    <section id="sotd">
      Feedback on this proposal is strongly encouraged. Please open
      <a href="https://github.com/webrecorder/wacz-spec/issues/">GitHub issues</a>
      with any questions or to suggest use cases.
    </section>

    <section id="abstract">
      WACZ is a <a>media type</a> that allows web archive <a>collections</a> to be
      <a>packaged</a> and shared on the web as a discrete file. A WACZ file includes
      all the data that is needed for the rendering archived content as well as
      <a>contextual information</a> required for users to interpret it. Rendering
      software can obtain this data on demand using HTTP Range requests,
      without requiring the entire file to be fully retrieved, or for it to be
      otherwise mediated by specialized server side software.
    </section>

    <section id="conformance"></section>

    <section id="terminology">

      <h2>Terminology</h2>
      
      <div>
        <p>
          This section defines the terms used in this specification and
          throughout web archives infrastructure. A link to these terms
          is included whenever they appear in this specification.
        </p>
        <dl class="termlist">

          <dt><dfn id="dfn-cdx">CDX</dfn></dt>
          <dd>A file format specification for representing an index to archived
          web content. It is used by web replay tools to lookup if and when a
          given URL has been archived in a set of <a>WARC</a> files.</dd>

          <dt><dfn id="dfn-cdxj">CDXJ</dfn></dt>
          <dd>A <a>CDX</a> file encoded using [[JSON]]. See the 
            <a href="#cdxj">CDXJ section</a> below.</dd>

          <dt><dfn id="dfn-collection">Collection</dfn></dt>
          <dd>An arbitrary set of related archived web pages and metadata based on some
            topic, website domain(s), time period, or other conceptual grouping.</dd>

          <dt><dfn id="dfn-context" data-lt="contextual information">Context</dfn></dt>
          <dd>Descriptive information about a web archive that helps a person
            using that web archive understand and interpret what the archive
            contains. This information can include why the content was selected
            for the archive, when it was created, who created it, and what tools 
            or applications were used to create it.</dd>

          <dt><dfn id="dfn-iipc">IIPC</dfn></dt>
          <dd>The International Internet Preservation Consortium. An
            organization of libraries, archives and other organizations
            established in 2003 to coordinate efforts to preserve web content.
          </dd>

          <dt><dfn id="dfn-mediatype">Media Type</dfn></dt>
          <dd>A two-part identifier  for file formats that are transferred on the
            World Wide Web and the underlying Internet. [[IANA-MEDIA-TYPES]].
          </dd>

          <dt><dfn id="dfn-package" data-lt="packaging|packaged">Package</dfn></dt>
          <dd>A file format that allows distinct files or bitstreams to be
            represented within it. Popular examples of packaging formats
            include ZIP, PDF, MP4, tar and Open Office XML.</dd>

          <dt><dfn id="dfn-webpage" data-lt="pages">Page</dfn></dt>
          <dd>A web document as viewed in a web browser that is viewing a
            specific URL. Sometimes referred to as a <em>web page</em>.</dd>

          <dt><dfn id="dfn-wacz" data-lt="web archive collection">WACZ</dfn></dt>
          <dd>Web Archive Collection Zipped. A file that conforms to this specification 
            which is used to package up <a>WARC</a> data and metadata into a
            <a>ZIP</a> file for distribution and replay on the web</dd>

          <dt><dfn id="dfn-warc">WARC</dfn></dt>
          <dd>A file containing concatenated representations of web resources conforming 
            to the [[WARC]] specification.</dd>

          <dt><dfn id="dfn-wayback">Wayback Machine</dfn></dt>
          <dd>A well known web application for replaying archived web pages that
            was initially developed at the Internet Archive and has been forked
            as an open soruce application by the <a>IIPC</a>.</dd>

          <dt><dfn id="dfn-web-archive">Web Archive</dfn></dt>
          <dd>A collection of files that preserve representations of web
            resources in the WARC format. A web archive may also include
            derivative files such as CDX indexes for accessing records within
            the archive.</dd>

          <dt><dfn id="dfn-zip-file" data-lt="zip">ZIP file</dfn></dt>
          <dd>A file conforming to the [[ZIP]] specification which is used to 
            aggregate, compress, and encrypt files into a single interoperable 
            container. WACZ allows for both ZIP and ZIP64 encodings for larger
            archives.</dd>

        </dl>
      </div>

    </section>

    <section data-format="markdown">

# Introduction

This specification defines a directory structure and <a>ZIP</a> format
specification for sharing and distributing <a>web archives</a>. <a>ZIP</a> files
using this format can be referred to as <a>WACZ</a> (Web Archive Collection
Zipped).

## Motivation

The goal of this specification is to provide a portable format for 
<a>web archives</a> in order to achieve two broad goals for web archives:

1. *Social*: to provide an interoperable way of sharing web archive
<a>collections</a> that includes the <a>contextual information</a> needed 
   for users to interpret and meaningfully interact with them.

2. *Technical*: to provide an efficient way to dynamically load 
   *small amounts of data* from a remotely hosted file  
   on static storage, without requiring the entire file 
   to be downloaded, or for the intervention of specialized 
   server side applications.

To use and make sense of a web archive collection, it is necessary to have the
archived web content as well as <a>contextual information</a> that describes what the
collection contains as well as when and how it was created. The collection also
requires a set of entry points or <a>pages</a> to use for browsing the collection.

All of this data needs to be <a>packaged</a> together so that the various pieces can be
easily copied and transferred without accidentally separating them. This data
package needs to to be easily transported from one storage system to another, 
sent as an attachment in an email, placed on a thumb drive, and hosted by simply
serving it up at a given URL as a static document, possibly from cloud object
storage, or a CDN.

Hosting web archives currently requires complex server infrastructure (e.g. a
<a>Wayback Machine</a>) to serve <a>WARC</a> data in such a way that can be
viewed in the browser. The <a>WACZ</a> format provides a storage approach
optimized for efficient random-access to <a>packaged</a> up WARC data that allows 
the browser to render a page by fetching only what is needed for that
particular page. This is done by leveraging the <a>ZIP</a> format's built-in
index to locate the contents of the web archive and its constituent metadata.

WACZ is not designed to replace other web archiving formats. Rather it
establishes a file <a>packaging</a> convention for all the data needed by a browser for
efficient rendering of a web archive collection, and its contextualization.

## Existing Tools 

The [py-wacz](https://github.com/webrecorder/py-wacz) repository contains a
reference implementation for creating WACZ files from existing WARC files, and
validating them. Parts of the specification are also implemented and in use by
[wabac.js](https://github.com/webrecorder/wabac.js) and
[ReplayWeb.page](https://replayweb.page).

    </section>

    <section data-format="markdown">

# WACZ Object

A WACZ object consists of the following:

1. A `datapackage.json` file for recording technical and descriptive metadata
   specified in [[FRICTIONLESS-DATA-PACKAGE]].

2. An extensible directory and naming convention for <a>web archive</a> data.

3. A method for bundling the directory layout in a <a>ZIP</a> file.

## Directory Layout

A <a>WACZ</a> contains a directory structure, that contains web archive
collection data which MUST conform to the [[FRICTIONLESS-DATA-PACKAGE]]
specification. This directory structure looks like:

<pre class="example">
├── archive
│   └── data.warc.gz
├── datapackage.json
├── indexes
│   └── index.cdx
└── pages
    └── pages.jsonl
</pre>

## Directories and Files

### archive

The `archive` directory MUST contain one or more files in the [[WARC]] format. 
The files SHOULD use the `.warc` file extension unless they are GZIP encoded in 
which case they MUST use the `.warc.gz` file extension.

<pre class="example">
archive
└── data.warc
</pre>

### indexes

The `indexes` directory MUST include one or more indexes for the raw data stored
in `archive`. These files MUST use the `.cdx` file extension and use the
compressed <a>CDXJ</a> format. 

<pre class="example">
indexes
└── index.cdx
</pre>

### pages.jsonl

The `pages/pages.jsonl` MUST be present and include a list of 'Page' objects as
[[JSON-Lines]] where each line MUST contain at least the following properties:

- `url` - a URL for the page
- `ts` - a [[RFC3339]] datetime string

Each entry in the [[JSONL]] file MAY contain the following properties to aid in
navigating a web archive collection:

- `title` - a string describing the resource
- `id` - an arbitrary identifier for the resource
- `text` - text extracted from the snapshot
- `size` - an integer that representes the number of bytes for the page and all its resources

<pre class="example">
{"format": "json-pages-1.0", "id": "pages", "title": "All Pages"}
{"id": "1db0ef709a", "url": "https://www.example.com/page", "ts": "2020-10-07T21:22:36Z", "title": "Example Domain"}
{"id": "12304e6ba9", "url": "https://www.example.com/another", "ts": "2020-10-07T21:23:36Z", "title": "Another Page"}
</pre>

Each entry in the [[JSONL]] file MAY contain additional properties as long as
they do not interfere with the required properties.

Other [[JSONL]] files MAY be added on using the same format in the `pages/`
directory. A common use case is to include only the main pages in the
`pages.jsonl`, while including additional pages, such as those discovered
automatically via a crawl in an another file e.g. `extraPages.jsonl`.

### datapackage.json

The `datapackage.json` file MUST be present at the root of the WACZ which
serves as the manifest for the web archive and is compliant with the
[[FRICTIONLESS-DATA-PACKAGE]] specification. It MUST contain the following
keys:

- `profile`: Set to `data-package`
- `resources`: a list of file names, paths, sizes and fixity for all files
   contained in the WACZ.

<pre class="example">
"resources": [
   {
     "name": "pages.jsonl",
     "path": "pages/pages.jsonl",
     "hash": "sha256:8a7fc0d302700bed02294404a627ddbbf0e35487565b1c6181c729dff8d2fff6",
     "bytes": 75
   },
   {
     "name": "data.warc",
     "path": "archive/data.warc",
     "hash": "sha256:0e7101316ba5d4b66f86a371ee615fbd20f9d3f32d32563ed2c829db062f7714",
     "bytes": 11469796
   },
   ...
]
</pre>

The `datapackage.json` MUST be a valid [[JSON]] object and include properties
that allow rendering applications to present the user with <a>contextual
information</a> about the web archive:

- `profile`: the string "wacz/1.2.0"
- `title`: a string or one sentence description for the collection
- `description`: a longer description of the archive's contents 
   which MUST be Markdown formatted (plain text is valid Markdown)
   [[RFC7763].
- `created`: a [[RFC3339]] datetime for when the WACZ file was created
- `modified`: a [[RFC3339]] datetime for when the WACZ file was last modified
- `software`: A description of what software was used to create the WACZ file

Other properties from the [[FRICTIONLESS-DATA-PACKAGE]] specification such as
`licenses`, `version`, `organization`, `contributors`, `email` MAY be used. 
Custom properties that do not interfere with pre-existing properties MAY also 
be used.

The `datapackage.json` SHOULD include a `home` object to assist 
in initial replay of the web collection. This allows rendering software
to choose what initial page to be displayed after opening a WACZ collection. 
If present the `home` object MUST include the following properties:

- `url`: The URL of the collection's home page
- `ts`: An [[RFC3339]] date for when the snapshot of URL was made

## CDXJ

The CDXJ format provides a standardized way of representing the files in
`/indexes` which point to the content WARC present in the WACZ's `/archive`
directory. CDXJ files can be generated automatically by reading the archived
WARC data. A reference implementation can be found in the
[py-wacz](https://github.com/webrecorder/py-wacz) project.

<p class="note">
CDXJ's name name and semantics partly derive from an earlier index format
developed as part of the Internet Archive's <a>Wayback Machine</a>, where CDX
may have been an acronym for Crawl (or Capture) inDeX. The CDXJ format used in
WACZ was mostly drawn from an earlier implementation in the Webrecorder
application [[WEBRECORDER-CDX]].
</p>

A CDXJ file is a sorted, line oriented plain-text file (optionally GZIP
compressed) where each line represents information about a single capture in a
web archive collection.

Each line MUST have three components that are separated by single spaces (0x20):

1. a Searchable URL
2. an Integer Timestamp
3. a JSON Block 

### Searchable URL

The Searchable URL is a normalized form of the archived URL that allows a
CDXJ file to be sorted and efficiently scanned using a binary search algorithm.
The Searchable URL is sometimes referred to as Sort-friendly URI Reordering
Transform (SURT).

The steps for creating a Searchable URL from a URL are:

1. lowercasing the URL
2. removing the protocol portion (HTTP or HTTPS)
3. replacing the host name portion of the URL with a reversed, comma separated
equivalent: `www.example.org becomes `org,example,www`
4. adding a `)` separator
5. adding the remaining portion of the URL (path and query)

For example the URL ```https://www.example.org/index.html``` would be
represented as this Searchable URL ```org,example,www)/index.html```

### Integer Timestamp

The Integer Timestamp is an integer representation of the date and time (UTC)
when the web archive snapshot was created. It is composed of:

- 4 digit year (e.g. 2022)
- 2 digit month (e.g. 02)
- 2 digit day (e.g. 05)
- 2 digit hour in 24 hour format (e.g. 23)
- 2 digit minute (e.g. 13)
- 2 digit second (e.g. 59)
- 3 digit milliseconds MAY be included (e.g. 032)

This example date would get serialized as the Integer Timestamp
`20220205231359032`.

### JSON Block 

The JSON Block contains a serialized [[JSON]] object with newlines escaped so
that it fits completely on one line. The object MUST contain the following
properties:

- url: The URL that was archived
- digest: A cryptographic hash for the HTTP response payload
- mime: The <a>media type</a> for the response payload
- filename: the WARC file `/archive` where the WARC record is located
- offset: the byte offset for the WARC record
- length: the length in bytes of the WARC record
- status: the HTTP status code for the HTTP response

### Sorting

The lines in a CDXJ file MUST be sorted to allow a given URL (and timestamp) to
be looked up efficiently using a simple binary search. The sorting should be
done based on the native byte values of the characters. This is equivalent to
using the GNU sort with the collation settings `LC_ALL=C`.

### Example

The following is an example of a complete line from a CDXJ file:

```
org,example)/index.html 20220106150849300 {"url":"https://example.org/index.html","digest":"sha-256:a8c5ac6f47aa34c5c5183daedc6ebbc7ca1e53fd2ec7db5e98d71bffb163b2ce","mime":"image/png","offset":283,"length":2269,"recordDigest":"sha256:e520b333999144ff38f593f6d76f5333d24895701953b2ea0507ed041d20ca2c","status":200,"filename":"data.warc.gz"}
```

## Signing and Verification

While a WACZ is not required to be signed it MAY include additional files to
support the cryptographic signing of archived web content. An example of this is
the [[?WACZ-SIGNING]] extension that adds a `datapackage-digest.json` file to
the root of the WACZ, which in turn contains a hash of the `datapackage.json`
file, a public key, and a signature. This information can then be used by tools
to determine who created the WACZ and to verify that the contents of the archive
have not changed. The WACZ specification does not currently specify or require a
particular trust model for archived web content in order to encourage practice
and experimentation.

## Other files and directories

Other files and directories MAY be present in a WACZ as long as they do 
not interfere with specified files and directories that are used by WACZ.
Specifically, custom files and directories MUST NOT be added to the existing WACZ directories, `archive`, `indexes` and `pages`. Additional files MUST be listed in the resources section of `datapackage.json` to ensure conformance with [[FRICTIONLESS-DATA-PACKAGE]]

## Zip Format

The entire directory structure MUST be stored in a standard [[ZIP]] file.

### Zip Compression

Already compressed files MUST NOT be compressed again to allow for random access.

- All `archive/` files should be stored in ZIP with 'STORE' mode.
- All `index/*.cdx.gz` files should be stored in ZIP with 'STORE' mode.
- All files (`*.jsonl`, `*.json`, `*.idx`, `*.cdx`, `*.cdxj`) can be stored in 
  the ZIP with either 'DEFLATE' or 'STORE' mode.

### Zip Format File Extension

A ZIP file that follows this Web Archive Collection format spec MUST use the extension `.wacz`.

Such a file can be referred to as a WACZ file or a WACZ.

### Media Type

WACZ files SHOULD be served via HTTP using the `application/wacz`
<a>media type</a>.

    </section>

    <section data-format="markdown">

# Processing Model

The [[ZIP]] file format provides efficient random access, which means archived
web pages can be retrieved efficiently even from large web archive collections
without requiring the entire WACZ to be transferred. WACZ files can be stored
as web accessible static files and read on-demand using HTTP RANGE requests
[[RFC7233]].

The processing model works as follows. Given a ZIP file, a client can quickly:

1. Read all entries to determine the contents of the ZIP file
2. Load collection metadata from the `datapackage.json`
3. Load a list of pages from `pages.jsonl`, if any

To lookup a given URL the client needs to:

1. Read the full CDX from ZIP
2. Binary search index looking for the URL
3. If a match found, get offset/length/location in WARC
4. Read compressed WARC chunk in ZIP

This approach is being used by [ReplayWeb.page](https://replayweb.page)

    </section>

  </body>

</html>
