<html>
  <head>
  <title>Web Archive Collection Zipped (WACZ)</title>
  <script src="https://www.w3.org/Tools/respec/respec-w3c" class="remove" defer ></script>
  <script class="remove">
    var respecConfig = {
      specStatus: "unofficial",
      publishDate: "2021-11-04",
      thisVersion: "https://webrecorder.github.io/wacz-format/1.2.0/",
      latestVersion: "https://webrecorder.github.io/wacz-format/latest/",
      shortName: "wacz-format",
      lint: {
	// turn off w3c-specific linting
	"privsec-section": false,
	"no-http-props": false,
	"no-headingless-sections": false
      },
      includePermalinks: true,
      editors: [
	{
	  name: "Ilya Kreymer",
	  url: "https://www.linkedin.com/in/ilya-kreymer-55110093/",
	  company: "Webrecorder",
	  companyURL: "https://webrecorder.net/"
	},
        {
          name: "Ed Summers",
          url: "https://www.linkedin.com/in/esummers/",
          company: "Stanford University",
          companyURL: "https://stanford.edu"
        }
      ],
      group: {
        name: "WACZ Editors",
        url: "https://webrecorder.net"
      },
      wgPublicList: "",
      otherLinks: [
	{
	  key: "Additional Documents",
	  data: [
	    {
	      value: "Specification",
	      href: "https://webrecorder.github.io/wacz-spec/latest/",
	    }
	  ]
	},
	{
	  key: "Previous version",
	  data: [
	      {
		  value: "1.1.1",
		  href: "https://github.com/webrecorder/wacz-spec/tree/4fb485e018f45996bfb1d992f937b67f3d6c79a9"
	      }
	  ]
      	},
	{
	  key: "Repository",
	  data: [
	    {
	      value: "Github",
	      href: "https://github.com/webrecorder/wacz-format"
	    },
	    {
	      value: "Issues",
	      href: "https://github.com/webrecorder/wacz-format/issues"
	    },
	    {
	      value: "Commits",
	      href: "https://github.com/webrecorder/wacz-format/commits"
	    },
	    {
	      value: "Use Cases",
	      href: "https://webrecorder.github.io/wacz-spec/use-cases/",
	    }
	  ]
      	}
      ],
      maxTocLevel: 3,
      logos: [
	{
	  src: "https://webrecorder.github.io/wacz-spec/1.2.0/images/wacz.png",
	  alt: "WACZ Logo",
          height: 100
      	}
      ],
      localBiblio: {
      }
    };
  </script>
  </head>

  <body>

    <p id="sotd">
      This document is working draft/proposal for a directory structure and ZIP
      format specification for sharing and distributing web archives. ZIP files
      using this format can be referred to as WACZ (Web Archive Collection
      Zipped). Feedback on this proposal is strongly encouraged!. Please open
      <a href="https://github.com/webrecorder/wacz-spec/issues/">GitHub issues</a>
      with any questions, suggests or use cases.
    </p>

    <section id="abstract">
      WACZ is a packaging format that allows web archives to become a first class
      media type on the web. It achieves this by addressing two key social and
      technical issues. WACZ provides an interoperable way to share web archive
      <em>collections</em>, including any data necessary to make web archives
      useful for people to understand what they contain. In addition WACZ has been
      designed to provide an efficient way of loading *discrete amounts of data*
      from a remotely hosted web archive on static storage, without requiring the
      entire collection to be retrieved. 
    </section>

    <section id="conformance"></section>

    <section id="terminology">

      <h2>Terminology</h2>
      
      <div>
        <p>
          This section defines the terms used in this specification and
          throughout web archives infrastructure. A link to these terms
          is included whenever they appear in this specification.
        </p>
        <dl class="termlist">

          <dt><dfn id="dfn-cdx">CDX</dfn></dt>
          <dd>A file format specification for representing an index to archived
          web content. It is used by web replay tools to lookup if and when a
          given URL has been archived in a set of <a>WARC</a> files.</dd>

          <dt><dfn id="dfn-cdxj">CDXJ</dfn></dt>
          <dd>A <a>CDX</a> file encoded using <a>JSONL</a>. TODO: link to CDXJ
            spec.</dd>

          <dt><dfn id="dfn-collection">collection</dfn></dt>
          <dd>An arbitrary set of related archived web pages and metadata based on some
            topic, website domain(s), time period, or other conceptual grouping.</dd>

          <dt><dfn id="dfn-iipc">IIPC</dfn></dt>
          <dd>The International Internet Preservation Consortium. An
            organization of libraries, archives and other organizations
            established in 2003 to coordinate efforts to preserve web content.
          </dd>

          <dt><dfn id="dfn-jsonl">JSONL</dfn></dt>
          <dd>JSON Lines, or new line delimited JSON (NDJSON). A text based <a
              href="https://jsonlines.org/">file format</a> where each line
            contains a valid JSON value. It is convenient for storing structured
          data that is to be processed one record at a time.</dd>

          <dt><dfn id="dfn-pywacz" data-lt="py-wacz">PyWACZ</dfn></dt>
          <dd>A reference implementation of <a>WACZ</a> written in Python for
            working with web archive data.</dd>

          <dt><dfn id="dfn-replaywebpage">ReplayWeb.page</dfn></dt>
          <dd>An <a href="https://github.com/webrecorder/replayweb.page">open
            source</a> client side web archive replay system that runs
          completely in the browser.</dd>

          <dt><dfn id="dfn-wacz" data-lt="web archive collection">WACZ</dfn></dt>
          <dd>Web Archive Collection Zipped. A file that conforms to this specification 
            which is used to package up <a>WARC</a> data and metadata into a
            <a>ZIP</a> file for distribution and replay on the web</dd>

          <dt><dfn id="dfn-wabac" data-lt="wabac">wabac.js</dfn></dt>
          <dd>An <a href="https://github.com/webrecorder/wabac.js">open
            source</a> client side JavaScript library for replaying archived
            web content using service workers.</dd>

          <dt><dfn id="dfn-warc">WARC</dfn></dt>
          <dd>A file containing concatenated representations of web resources conforming 
            to the [[WARC]] specification.</dd>

          <dt><dfn id="dfn-wayback">Wayback Machine</dfn></dt>
          <dd>A well known web application for replaying archived web pages that
            was initially developed at the Internet Archive and has been forked
            as an open soruce application by the <a>IIPC</a>.</dd>

          <dt><dfn id="dfn-web-archive">web archive</dfn></dt>
          <dd>A collection of files that preserve representations of web
            resources in the WARC format. A web archive may also include
            derivative files such as CDX indexes for accessing records within
            the archive.</dd>

          <dt><dfn id="dfn-zip-file" data-lt="zip">ZIP file</dfn></dt>
          <dd>A file conforming to the [[ZIP]] specification which is used to 
            aggregate, compress, and encrypt files into a single interoperable 
            container.</dd>

        </dl>
      </div>

    </section>

    <section data-format="markdown">

# Introduction

This document defines a directory structure and <a>ZIP</a> format specification for
sharing and distributing <a>web archives</a>. <a>ZIP</a> files using this format can 
be referred to as <a>WACZ</a> (Web Archive Collection Zipped).

## Motivation

The goal of this specification is to provide a portable format for <a>web archives</a>,
to address key social and technical issues:

- Social: to provide an interoperable way to share web archive
<a>collections</a>,
  including any data necessary to make web archives useful to people.
- Technical: to provide an efficient way to load *small amounts of data* 
  from a remotely hosted web archive on static storage, without requiring 
  the entire <a>WACZ</a> to be downloaded.

### Social: Making web archives more human friendly

To make sense of and use a web archive, it is necessary to have more than just the
raw HTTP request/response data, yet no standardized format exists to include all
the data that is needed.

In particular, a web archive <a>collection</a> should have:
- A random-access index of all raw data (preferably accessible with minimal seek)
- A set of pages, entry point URLs from which users should browse the web archive.
- Other user-defined, editable metadata about the web archive <a>collection</a> (title, description, etc...)

All of this data can be bundled together into a single file, using the standard
<a>ZIP</a> format.

### Technical: Lowering the barrier to hosting large web archives

Hosting web archives currently requires complex server infrastructure, a
<a>Wayback Machine</a> to serve data in a way that can be viewed in the browser.

Tools like <a>wabac.js</a> provide a way to render the data directly in the browser, if it can be accessed efficiently.

The <a>WACZ</a> format presents a storage approach optimized for efficient
random-access to large amounts of web archive data, allowing the client to load
only what is needed by seeking into a larger file (via HTTP range requests or
other random access) and loading only what is needed for each page. This is done
by leveraging the <a>ZIP</a> format's built-in index, inclusion of an efficient web
archive index (<a>CDX</a> or compressed <a>CDX</a>) along with the raw
<a>WARC</a> data.

The spec is not designed to replace any other format, but to set up a convention-based format to bundle all necessary data together,
following a certain directory and naming convention, into a standard ZIP (or ZIP64) file.

## Existing Tools 

The [py-wacz](https://github.com/webrecorder/py-wacz) repository contains a
reference implementation for creating WACZ files from existing WARC files, and
validating them.

Parts of the specification are also implemented and in use by
[wabac.js](https://github.com/webrecorder/wabac.js) and
[ReplayWeb.page](https://replayweb.page).


    </section>

    <section data-format="markdown">

# WACZ Object 

The spec currently consists of the following:

1) A `datapackage.json` file for recording metadata specified in [[FRICTIONLESS-DATA-PACKAGE]].
2) A extensible directory and naming convention for web archive data
3) A specification for bundling the directory layout in a ZIP file.

The documentation is split into what is currently supported in [wabac.js](https://github.com/webrecorder/wabac.js) as stable,
experimental ideas, and possible future extensions.

See the [CHANGES.md](CHANGES.md) file for a list of changes to WACZ spec and py-wacz tool.


## Directory Layout

A <a>WACZ</a> contains a directory structure, that contains web archive
collection data which conforms to the [[FRICTIONLESS-DATA-PACKAGE]]
specification. This directory looks like:

<pre>
<code>
├── archive
│   └── data.warc.gz
├── datapackage-digest.json
├── datapackage.json
├── indexes
│   └── index.cdx
└── pages
    └── pages.jsonl
</code>
</pre>

## Directories and Files

### archive/

The `archive` directory can contain raw web archive data.

Currently supported formats:
- WARC (.warc, .warc.gz)

### indexes/

 The `indexes` directory should include one or more indexes for the raw data stored
 in `archive/`. These files MUST use the `.cdxj` file extension and use the
 compressed <a>CDXJ</a> format. 

### pages.jsonl

The `pages/pages.jsonl` file is a list of 'Page' objects as <a>JSONL</a> where  
each line MUST contain at least the following fields:

- `url` - a valid URL (or URI/URN?)
- `ts` - a valid ISO 8601 Date string

Each entry in the JSONL file MAY contain the following fields:

- `title` - a string describing the resource
- `id` - an arbitrary identifier for the resource
- `text` - text extracted from the snapshot
- `size` - an integer that representes the number of bytes for the page and all its resources

Ex:
```jsonl
{"format": "json-pages-1.0", "id": "pages", "title": "All Pages"}
{"id": "1db0ef709a", "url": "https://www.example.com/page", "ts": "2020-10-07T21:22:36Z", "title": "Example Domain"}
{"id": "12304e6ba9", "url": "https://www.example.com/another", "ts": "2020-10-07T21:23:36Z", "title": "Another Page"}
```

Other <a>JSONL</a> files MAY be added on using the same format in the `pages/` directory.

For example, <a>py-wacz</a> supports specifying an 'extra' pages list, loaded from `extraPages.jsonl`.

A common use case is to include only the main pages in the `pages.jsonl`, while including additional pages, such as those discovered automatically
via a crawl in an `extraPages.jsonl`.

### datapackage.json

The `datapackage.json` file MUST be present which serves as the manifest for the
web archive and is compliant with the [[FRICTIONLESS-DATA-PACKAGE]]
specification. It MUST contain the following keys:

- `wacz_version`: The version of WACZ being used. (e.g. 1.2.0)
- `profile`: Set to `data-package`
- `resources` is a list containing the contents of the WACZ

  Ex:
   ```
    "resources": [
       {
         "name": "pages.jsonl",
         "path": "pages/pages.jsonl",
         "hash": "sha256:8a7fc0d302700bed02294404a627ddbbf0e35487565b1c6181c729dff8d2fff6",
         "bytes": 75
       },
       {
         "name": "data.warc",
         "path": "archive/data.warc",
         "hash": "sha256:0e7101316ba5d4b66f86a371ee615fbd20f9d3f32d32563ed2c829db062f7714",
         "bytes": 11469796
       },
       ...
   ]
   ```

WACZ data packages SHOULD also include optional data package fields, in particular:

- `title`: Can contain title for this collection.

- `description`: Can contain description for this collection.

- `created`: ISO date string for when the WACZ file was created.

- `modified`: ISO date tring for when the WACZ file was last modified.

The following fields are not specified by the [[FRICTIONLESS-DATA-PACKAGE]] and are
specific to <a>WACZ</a>: 


- `mainPageURL`: An optional URL of the main or starting page in the collection,
if any, to be used for initial replay.

- `mainPageDate`: An optional ISO-formatted date of the main or starting page in the collection, if any, to be used for initial replay. Specified only if `mainPageURL` is specified.

- "software": A description of what software was used to create the WACZ file

### datapackage-digest.json 

With WACZ 1.1, there is now also support for a special *datapackage-digest.json*, which makes it possible to verify the *datapackage.json* manifest
with a hash, and an optional signature, and thus for the entire contents of the WACZ.

The `hash` and `path` keys are required, while `signature` and `publicKey` are optional.

**TODO: align with current archiveweb.page implementation?**

Ex:
  ```json
  {
    "hash": "sha256:...",
    "path": "datapackage.json",
    "signedData": {
    "signature": "...",
    "publicKey": "..."
  }
  ```

## Record Digests

With WACZ 1.1, index entries for each individual WARC record in the index (CDX) includes a digest of the WARC record.

When a compressed CDX with a secondary index is used, each entry in the secondary index also includes a digest field.

This makes it possible to also verify each URL as it is loaded via random access, without downloading the entire WACZ file.

## Custom Derivatives

**TODO: clearly describe how new directories may be added and impact on
WACZ validators.**

Other derived data, such as screenshots, could be placed into a general-purpose
`derivatives/` directory.

Additional ideas for standardization and possible directory formats:
- derivatives
- search indexes
- WAT / WET files
- specific metadata formats?

Perhaps extension need not be specified explicitly, as others can add directories as needed.
*Feedback wanted on this section, see https://github.com/webrecorder/web-archive-collection-format/issues/1*

## Zip Format

The entire directory structure MUST be stored in a standard ZIP or ZIP64 file.

The ZIP format is useful as a primary packaging of all the different formats.


### Zip Compression

Already compressed files MUST NOT be compressed again to allow for random access.

- All `archive/` files should be stored in ZIP with 'STORE' mode.
- All `index/*.cdx.gz` files should be stored in ZIP with 'STORE' mode.
- All files (`*.jsonl`, `*.json`, `*.idx`, `*.cdx`, `*.cdxj`) can be stored in the ZIP with either 'DEFLATE' or 'STORE' mode.

### Zip Format File Extension

A ZIP file that follows this Web Archive Collection format spec MUST use the extension `.wacz`.

Such a file can be referred to as a WACZ file or a WACZ.

    </section>

    <section data-format="markdown">

# Processing Model

The web archive collection format stored in a ZIP file allows for efficient random access to even very large web archives (10GB+, 100GB+, etc...). This allows for loading web archive from static storage on-demand.

The approach works as follows. Given a ZIP file, a client can quickly:

1. Read all entries to determine the contents of the ZIP file via random access
2. Load manifest from `datapackage.json`
3. Load list of pages from `pages.jsonl`, if any

To lookup a given URL, such as from the page or page list:

1. Read the full CDX from ZIP, or read secondary secondary index (IDX)
2. Binary search index.
3. If index match found, get offset/length/location in WARC
4. Read compressed WARC chunk in ZIP

This approach is being used by <a>ReplayWeb.page</a>

    </section>

  </body>

</html>
